<!DOCTYPE html>  <html> <head>   <title>crawler.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               crawler.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>Crawler.js</strong> is a web crawler written in JavaScript/PhantomJS.</p>

<p>Originally developer for <a href="http://pagerjs.com">pager.js</a>.</p>

<p>Source code on <a href="http://github.com/finnsson/crawlerjs/">GitHub</a>. MIT License.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Get all arguments passed to crawler</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">).</span><span class="nx">args</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Set the start argument index to 1 (since 0 is the name of the file)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Find out if any URL pattern should be ignored while crawling the site</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">ignorePatterns</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;-i&#39;</span> <span class="o">||</span> <span class="nx">args</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;--ignore&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ignorePatterns</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nx">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Fetch the URL from the argument list</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">startUrl</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Add the start URL to the list of total URLs
and to the list of not yet visited pages.
<code>visitingPages</code> is an integer over the current number of visiting pages.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">pages</span> <span class="o">=</span> <span class="p">[</span><span class="nx">startUrl</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">notVisitedPages</span> <span class="o">=</span> <span class="p">[</span><span class="nx">startUrl</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">visitingPages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><code>notVisitingPages</code> holds all URLs that are about to be visited but PhantomJS
hasn't loaded yet (since we don't want to load 100s of pages as the same time).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">notVisitingPages</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>If no arguments are provided: print the help information:</p>

<pre><code>Usage: phantomjs --load-images=no crawler.js [options] url

Options:
  --ignore, -i    url pattern to ignore

Example:
  phantomjs --load-images=no
    crawler.js -i /some/url/\d* http://example.com/
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">startUrl</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Usage: phantomjs --load-images=no crawler.js [options] url&quot;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Options:&quot;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;  --ignore, -i   url pattern to ignore&quot;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Example:&quot;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;  phantomjs --load-images=no crawler.js -i /some/url/\d* http://example.com/ &quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Include the file system module. We'll need it when storing files to disc later</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Include the webpage module. This module can create web pages!</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">webpage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;webpage&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Load the scripts jquery ($), q (Q) and underscore (_) so we can use them</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">phantom</span><span class="p">.</span><span class="nx">injectJs</span><span class="p">(</span><span class="s1">&#39;jquery-1.8.2.min.js&#39;</span><span class="p">);</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">injectJs</span><span class="p">(</span><span class="s1">&#39;q.min.js&#39;</span><span class="p">);</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">injectJs</span><span class="p">(</span><span class="s1">&#39;underscore-min.js&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Helper method for removing an item from an array
Used like</p>

<pre><code>removeA([1,2,4,5], 4) === [1,2,5]
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">removeA</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">what</span><span class="p">,</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">,</span> <span class="nx">L</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">ax</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">L</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">what</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="o">--</span><span class="nx">L</span><span class="p">];</span>
            <span class="k">while</span> <span class="p">((</span><span class="nx">ax</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">what</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">arr</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">ax</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h2>processPage</h2>

<p>This method is called with a loaded page instance and the URL of
that page instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">processPage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>saveHref</h3>

<p><code>actions</code> is an object with a key <code>saveHref</code>. This key/method
is called by the <code>window.callPhantom</code>-method inside a <code>page.evaluate</code>-
callback. Using <code>callPhantom</code> it is possible for PhantomJS to pass
serializable data out from a web page into this script.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">actions</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>The <code>saveHref</code> method will analyze the href provided
and decide if the href is a link to a new URL that
should be crawled.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">saveHref</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">href</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>check if href contains #!/</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">href</span> <span class="o">&amp;&amp;</span> <span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;#!/&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>check if URI is inside <code>startUrl</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">startUrl</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>make sure URL isn't in pages-array already</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">pages</span><span class="p">,</span> <span class="nx">href</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>check if the URL should be ignored</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nx">ignorePatterns</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">return</span> <span class="nx">href</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
                            <span class="p">}))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>if not: add to pages-array and notVisitedPages</p>             </td>             <td class="code">               <div class="highlight"><pre>                                <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;adding URL: &quot;</span> <span class="o">+</span> <span class="nx">href</span><span class="p">);</span>
                                <span class="nx">pages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">href</span><span class="p">);</span>
                                <span class="nx">notVisitedPages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">href</span><span class="p">);</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">visitingPages</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="nx">visitingPages</span><span class="o">++</span><span class="p">;</span>
                                    <span class="nx">processUrl</span><span class="p">(</span><span class="nx">href</span><span class="p">);</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                    <span class="nx">notVisitingPages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">href</span><span class="p">);</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h3>page.onCallback</h3>

<p>React to <code>window.callPhantom</code>. If <code>obj.action === 'saveHref'</code> the method above
will be executed with the data in <code>obj.data</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">page</span><span class="p">.</span><span class="nx">onCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">actions</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">action</span><span class="p">](</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h3>page.evaluate</h3>

<p>Evaluate the page and run the callback in the scope of the web page.
Observe that the callback cannot access varialbes in this script that are outside
the callback! Instead the method must use <code>window.callPhantom</code> in order to send data
out of the callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">htmlCode</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">htmlTag</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="nb">document</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <ul>
<li>Find links
For each a-tag in the page, extract the href and send it to <code>saveHref</code>.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">links</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">htmlTag</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">links</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">linkIndex</span><span class="p">,</span> <span class="nx">link</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">href</span> <span class="o">=</span> <span class="nx">link</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
                <span class="nb">window</span><span class="p">.</span><span class="nx">callPhantom</span><span class="p">({</span>
                    <span class="nx">action</span><span class="o">:</span><span class="s1">&#39;saveHref&#39;</span><span class="p">,</span>
                    <span class="nx">data</span><span class="o">:</span><span class="nx">href</span>
                <span class="p">});</span>
            <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <ul>
<li>Clean up currently visible HTML by removing all elements that are hidden.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">hidden</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="nx">htmlTag</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;:hidden&#39;</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">hidden</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">hiddenIndex</span><span class="p">,</span> <span class="nx">hiddenElement</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">$el</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">hiddenElement</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">$el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;visibility&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;hidden&#39;</span> <span class="o">||</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">$el</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <ul>
<li>Remove script- and link-tags from the page.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="nx">htmlTag</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="nx">htmlTag</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Return the HTML content in the cleaned up HTML site as a string</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="nx">htmlTag</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerHTML</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h3>Save content</h3>

<p>Save polished HTML as {absolute-URL}<em>escaped</em>fragment_/hash/bang/value/index.html
E.g.</p>

<p>http://example.com/#!/some/cool/page</p>

<p>is stored as</p>

<p><em>escaped</em>fragment_/some/cool/page/index.html</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">compactHtml</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">compact</span><span class="p">(</span><span class="nx">htmlCode</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">totalFileName</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">startUrl</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">decodedParameter</span> <span class="o">=</span> <span class="nx">totalFileName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;#!/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">parameter</span> <span class="o">=</span> <span class="nx">decodedParameter</span> <span class="o">?</span> <span class="nx">decodedParameter</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">folderName</span> <span class="o">=</span> <span class="s1">&#39;_escaped_fragment_&#39;</span> <span class="o">+</span> <span class="nx">totalFileName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;#!/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">totalFolderName</span> <span class="o">=</span> <span class="nx">folderName</span> <span class="o">+</span> <span class="p">(</span><span class="nx">parameter</span> <span class="o">?</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">separator</span> <span class="o">+</span> <span class="nx">parameter</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>create folder/tree with name <code>totalFolderName</code></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">fs</span><span class="p">.</span><span class="nx">makeTree</span><span class="p">(</span><span class="nx">totalFolderName</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>create file index.html in folder with the content <code>compactHtml</code></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">fs</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">totalFolderName</span> <span class="o">+</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">separator</span> <span class="o">+</span> <span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="nx">compactHtml</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">);</span>

        <span class="nx">removeA</span><span class="p">(</span><span class="nx">notVisitedPages</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
        <span class="nx">visitingPages</span><span class="o">--</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Release the web page</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">page</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Are there any pages left to visit and are less that 2 pages visited at the moment?</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">notVisitingPages</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">visitingPages</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">lastUrl</span> <span class="o">=</span> <span class="nx">notVisitingPages</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">visitingPages</span><span class="o">++</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Then visit a not yet visited page.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">processUrl</span><span class="p">(</span><span class="nx">lastUrl</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h2>processUrl</h2>

<p>Process the URL provided. Start by loggins the URL to console.
Then create a new PhantomJS headless WebKit browser page.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">processUrl</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;processing url: &quot;</span> <span class="o">+</span> <span class="nx">url</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">webpage</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>


        <span class="kd">var</span> <span class="nx">pageIsOpened</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Load the web page.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">!==</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Unable to access network&#39;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">pageIsOpened</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">page</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Wait for 3 seconds once the page is loaded and then</p>

<ul>
<li>inject jquery into the page</li>
<li>start processing the page</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">pageIsOpened</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">page</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">page</span><span class="p">.</span><span class="nx">includeJs</span><span class="p">(</span><span class="s1">&#39;http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">processPage</span><span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">},</span> <span class="mi">3000</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <h2>Start</h2>

<p>Start processing the start URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">processUrl</span><span class="p">(</span><span class="nx">startUrl</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <h2>Exit</h2>

<p>Ask every second if all pages are visited. If so: exit phantom</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">notVisitedPages</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>


<span class="p">}());</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 